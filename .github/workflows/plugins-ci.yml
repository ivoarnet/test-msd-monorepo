name: Plugins CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/plugins/**'
      - '.github/workflows/plugins-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/plugins/**'
      - '.github/workflows/plugins-ci.yml'

env:
  DOTNET_VERSION: '8.0.x'
  BUILD_CONFIGURATION: 'Release'

jobs:
  build-and-test:
    name: Build and Test Plugins
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if solution exists
        id: check-solution
        run: |
          if [ -f "src/plugins/Contoso.Plugins.sln" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ Plugin solution not found - skipping build"
          fi

      - name: Setup .NET
        if: steps.check-solution.outputs.exists == 'true'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        if: steps.check-solution.outputs.exists == 'true'
        run: dotnet restore src/plugins/Contoso.Plugins.sln

      - name: Build solution
        if: steps.check-solution.outputs.exists == 'true'
        run: dotnet build src/plugins/Contoso.Plugins.sln --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore

      - name: Run unit tests
        if: steps.check-solution.outputs.exists == 'true'
        run: dotnet test src/plugins/Contoso.Plugins.sln --configuration ${{ env.BUILD_CONFIGURATION }} --no-build --verbosity normal --logger trx --collect:"XPlat Code Coverage"

      - name: Upload test results
        if: always() && steps.check-solution.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '**/TestResults/**/*.trx'

      - name: Upload code coverage
        if: steps.check-solution.outputs.exists == 'true'
        uses: codecov/codecov-action@v3
        with:
          files: '**/coverage.cobertura.xml'
          flags: plugins
          name: plugin-coverage

  package:
    name: Package Plugin Assemblies
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if solution exists
        id: check-solution
        run: |
          if [ -f "src/plugins/Contoso.Plugins.sln" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ Plugin solution not found - skipping packaging"
          fi

      - name: Setup .NET
        if: steps.check-solution.outputs.exists == 'true'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Build for release
        if: steps.check-solution.outputs.exists == 'true'
        run: dotnet build src/plugins/Contoso.Plugins.sln --configuration Release

      - name: Collect plugin DLLs
        if: steps.check-solution.outputs.exists == 'true'
        run: |
          mkdir -p artifacts/plugins
          find src/plugins/src -name "*.dll" -path "*/bin/Release/*" -not -path "*/ref/*" -exec cp {} artifacts/plugins/ \;

      - name: Create deployment package
        if: steps.check-solution.outputs.exists == 'true'
        run: |
          cd artifacts/plugins
          zip -r ../plugins-release.zip .
          cd ../..

      - name: Upload artifacts
        if: steps.check-solution.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: plugins-release
          path: artifacts/plugins-release.zip
          retention-days: 30

  deploy-dev:
    name: Deploy to Dev Environment
    runs-on: ubuntu-latest
    needs: package
    if: github.ref == 'refs/heads/main'
    environment:
      name: development
      url: https://yourorg-dev.crm.dynamics.com

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: plugins-release

      - name: Extract artifacts
        run: unzip plugins-release.zip -d plugins

      - name: Setup Power Platform CLI
        uses: microsoft/powerplatform-actions/actions-install@latest

      - name: Authenticate to Dataverse
        uses: microsoft/powerplatform-actions/who-am-i@latest
        with:
          environment-url: ${{ secrets.DATAVERSE_DEV_URL }}
          app-id: ${{ secrets.DATAVERSE_DEV_CLIENT_ID }}
          client-secret: ${{ secrets.DATAVERSE_DEV_CLIENT_SECRET }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}

      # Note: Actual plugin registration requires Plugin Registration Tool or custom scripts
      # This is a placeholder for deployment automation
      - name: Deploy plugins
        run: echo "Deploy plugins using Plugin Registration Tool or custom automation"
