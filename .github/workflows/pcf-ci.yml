name: PCF CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'pcf/**'
      - '.github/workflows/pcf-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'pcf/**'
      - '.github/workflows/pcf-ci.yml'

env:
  NODE_VERSION: '18.x'

jobs:
  build-and-test:
    name: Build and Test PCF Components
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'pcf/package-lock.json'

      - name: Install dependencies
        run: |
          cd pcf
          npm ci

      - name: Lint
        run: |
          cd pcf
          npm run lint || echo "Linting not configured"

      - name: Build PCF components
        run: |
          cd pcf
          npm run build

      - name: Run tests
        run: |
          cd pcf
          npm test || echo "Tests not configured"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pcf-components
          path: pcf/components/*/out/**
          retention-days: 30

  package:
    name: Package PCF Solution
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Power Platform CLI
        run: |
          npm install -g @microsoft/powerplatform-cli

      - name: Build PCF components
        run: |
          cd pcf
          npm ci
          npm run build

      - name: Create solution package
        run: |
          mkdir -p artifacts
          cd pcf
          # Pack each component into a solution
          # This is a simplified example - actual packaging may vary
          for component in components/*/; do
            if [ -d "$component" ]; then
              component_name=$(basename "$component")
              echo "Packaging $component_name"
              cd "$component"
              pac pcf push --publisher-prefix contoso || echo "Packaging $component_name"
              cd ../..
            fi
          done

      - name: Upload solution artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pcf-solution
          path: artifacts/*.zip
          retention-days: 30

  deploy-dev:
    name: Deploy to Dev Environment
    runs-on: ubuntu-latest
    needs: package
    if: github.ref == 'refs/heads/main'
    environment:
      name: development
      url: https://yourorg-dev.crm.dynamics.com

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: pcf-solution

      - name: Setup Power Platform CLI
        run: |
          npm install -g @microsoft/powerplatform-cli

      - name: Authenticate to Dataverse
        run: |
          pac auth create \
            --url ${{ secrets.DATAVERSE_DEV_URL }} \
            --applicationId ${{ secrets.DATAVERSE_DEV_CLIENT_ID }} \
            --clientSecret ${{ secrets.DATAVERSE_DEV_CLIENT_SECRET }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }}

      - name: Import PCF solution
        run: |
          for solution in *.zip; do
            if [ -f "$solution" ]; then
              echo "Importing $solution"
              pac solution import --path "$solution" --force-overwrite
            fi
          done
